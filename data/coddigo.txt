// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>><<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> NOVA VERSÃƒO TESTE 02/06/2025 <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>><<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

// process.env.NODE_TLS_REJECT_UNAUTHORIZED = "0";

// import dotenv from "dotenv";
// dotenv.config();

// import pkg from "openai";
// const { OpenAI } = pkg;
// import pool from "../config/db.js";
// import Papa from "papaparse";
// import fs from "fs";
// import path from "path";

// if (!process.env.OPENAI_API_KEY) {
//   throw new Error("âŒ OPENAI_API_KEY nÃ£o definida no .env");
// }

// const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

// // ============================================
// // ğŸ“š VARIÃVEIS GLOBAIS
// // ============================================
// let cursosDisponiveis = [];
// let cidadesDisponiveis = [];
// let dicionarioDescricoes = {};
// let descricaoCarregada = false;

// // ============================================
// // ğŸ—‚ï¸ FUNÃ‡ÃƒO PARA CARREGAR CURSOS
// // ============================================
// function carregarCursosDoCSV() {
//   try {
//     const csvPath = path.join(process.cwd(), "src", "data", "novos_cursos.csv");
//     console.log(`ğŸ“ Tentando carregar: ${csvPath}`);

//     if (!fs.existsSync(csvPath)) {
//       console.error(`âŒ Arquivo nÃ£o encontrado: ${csvPath}`);
//       return { cursosDisponiveis: [], cidadesDisponiveis: [] };
//     }

//     const csvData = fs.readFileSync(csvPath, "utf8");
//     console.log(`ğŸ“Š Tamanho do arquivo: ${csvData.length} caracteres`);

//     const result = Papa.parse(csvData, {
//       header: true,
//       skipEmptyLines: true,
//       dynamicTyping: false,
//       delimiter: ",", // ForÃ§a vÃ­rgula como separador
//       quoteChar: '"',
//     });

//     console.log(`ğŸ“Š Linhas processadas: ${result.data.length}`);
//     console.log(`ğŸ“‹ Colunas detectadas:`, result.meta.fields);

//     if (result.errors && result.errors.length > 0) {
//       console.warn("âš ï¸ Erros na parseaÃ§Ã£o:", result.errors);
//     }

//     const cursos = result.data;

//     // Debug do primeiro item
//     if (cursos.length > 0) {
//       console.log("\nğŸ” PRIMEIRO ITEM COMPLETO:");
//       Object.entries(cursos[0]).forEach(([key, value]) => {
//         console.log(`   "${key}": "${value}"`);
//       });
//     }

//     // EstratÃ©gias mÃºltiplas para extrair cursos
//     let cursosExtraidos = [];

//     // EstratÃ©gia 1: nome_curso
//     const estrategia1 = [
//       ...new Set(cursos.map((c) => c.nome_curso).filter(Boolean)),
//     ];
//     if (estrategia1.length > 0) {
//       cursosExtraidos = estrategia1;
//       console.log(
//         `âœ… Usando estratÃ©gia 1 (nome_curso): ${estrategia1.length} cursos`
//       );
//     }

//     // EstratÃ©gia 2: curso
//     if (cursosExtraidos.length === 0) {
//       const estrategia2 = [
//         ...new Set(cursos.map((c) => c.curso).filter(Boolean)),
//       ];
//       if (estrategia2.length > 0) {
//         cursosExtraidos = estrategia2;
//         console.log(
//           `âœ… Usando estratÃ©gia 2 (curso): ${estrategia2.length} cursos`
//         );
//       }
//     }

//     // EstratÃ©gia 3: Curso (maiÃºscula)
//     if (cursosExtraidos.length === 0) {
//       const estrategia3 = [
//         ...new Set(cursos.map((c) => c.Curso).filter(Boolean)),
//       ];
//       if (estrategia3.length > 0) {
//         cursosExtraidos = estrategia3;
//         console.log(
//           `âœ… Usando estratÃ©gia 3 (Curso): ${estrategia3.length} cursos`
//         );
//       }
//     }

//     // Extrair cidades
//     const cidadesExtraidas = [
//       ...new Set(cursos.map((c) => c.cidade).filter(Boolean)),
//     ];

//     console.log(`\nâœ… RESULTADO FINAL:`);
//     console.log(`   Cursos Ãºnicos: ${cursosExtraidos.length}`);
//     console.log(`   Cidades Ãºnicas: ${cidadesExtraidas.length}`);

//     if (cursosExtraidos.length > 0) {
//       console.log(
//         `   Exemplos de cursos: ${cursosExtraidos.slice(0, 3).join(", ")}`
//       );
//     }

//     if (cidadesExtraidas.length > 0) {
//       console.log(
//         `   Exemplos de cidades: ${cidadesExtraidas.slice(0, 3).join(", ")}`
//       );
//     }

//     // Atualizar variÃ¡veis globais
//     cursosDisponiveis = cursosExtraidos;
//     cidadesDisponiveis = cidadesExtraidas;

//     return {
//       cursosDisponiveis: cursosExtraidos,
//       cidadesDisponiveis: cidadesExtraidas,
//     };
//   } catch (error) {
//     console.error("âŒ Erro ao carregar cursos do CSV:", error);
//     return { cursosDisponiveis: [], cidadesDisponiveis: [] };
//   }
// }

// // ============================================
// // ğŸ“– FUNÃ‡ÃƒO PARA CARREGAR DESCRIÃ‡Ã•ES
// // ============================================
// function carregarDescricoesDoCSV() {
//   if (descricaoCarregada) {
//     return dicionarioDescricoes;
//   }

//   try {
//     const csvPath = path.join(
//       process.cwd(),
//       "src",
//       "data",
//       "curso_tecnicos.csv"
//     );

//     if (!fs.existsSync(csvPath)) {
//       console.warn("âš ï¸ Arquivo de descriÃ§Ãµes nÃ£o encontrado:", csvPath);
//       return {};
//     }

//     const csvData = fs.readFileSync(csvPath, "utf8");

//     const result = Papa.parse(csvData, {
//       header: true,
//       skipEmptyLines: true,
//       dynamicTyping: false,
//       delimiter: ",",
//       quoteChar: '"',
//     });

//     const descricoes = result.data;
//     dicionarioDescricoes = {};

//     // Processar cada linha do CSV
//     descricoes.forEach((row) => {
//       const nomeBruto = row["Nome do Curso"];
//       if (!nomeBruto) return;

//       // Normalizar o nome para busca
//       const nomeNormalizado = nomeBruto
//         .toLowerCase()
//         .normalize("NFD")
//         .replace(/[\u0300-\u036f]/g, "");

//       // Armazenar no dicionÃ¡rio
//       dicionarioDescricoes[nomeNormalizado] = {
//         nome: nomeBruto,
//         objetivo: row["Objetivos do Curso"] || "InformaÃ§Ã£o nÃ£o disponÃ­vel",
//         publicoAlvo: row["PÃºblico-Alvo"] || "InformaÃ§Ã£o nÃ£o disponÃ­vel",
//         ondeTrabalhar:
//           row["Onde Pode Trabalhar"] || "InformaÃ§Ã£o nÃ£o disponÃ­vel",
//       };
//     });

//     descricaoCarregada = true;
//     console.log(
//       `âœ… Carregadas descriÃ§Ãµes de ${
//         Object.keys(dicionarioDescricoes).length
//       } cursos`
//     );

//     return dicionarioDescricoes;
//   } catch (error) {
//     console.error("âŒ Erro ao carregar descriÃ§Ãµes do CSV:", error);
//     return {};
//   }
// }

// // ============================================
// // ğŸ” FUNÃ‡Ã•ES DE DETECÃ‡ÃƒO DE PERGUNTAS SOBRE DESCRIÃ‡ÃƒO
// // ============================================

// /**
//  * Detecta se o usuÃ¡rio estÃ¡ perguntando sobre descriÃ§Ã£o/conteÃºdo de um curso especÃ­fico
//  */
// function detectarPerguntaDescricao(userMessage) {
//   const msgLower = userMessage.toLowerCase();

//   // ExclusÃµes - NÃƒO sÃ£o perguntas sobre descriÃ§Ã£o
//   const exclusoes = [
//     /tem\?$/,
//     /vocÃªs tÃªm/,
//     /existe/,
//     /disponÃ­vel/,
//     /oferece/,
//     /em\s+\w+.*modalidade/,
//     /modalidade.*em\s+\w+/,
//     /na\s+modalidade.*em/,
//     /em\s+\w+.*ead|presencial/,
//     /quais\s+cursos/,
//     /que\s+cursos/,
//     /lista.*cursos/,
//   ];

//   if (exclusoes.some((regex) => regex.test(msgLower))) {
//     return false;
//   }

//   // InclusÃµes - SÃƒO perguntas sobre descriÃ§Ã£o
//   const palavrasChaveDescricao = [
//     /o que Ã©\s+(?:o\s+)?curso\s+de\s+\w+/,
//     /sobre\s+o\s+curso\s+de\s+\w+/,
//     /do que se trata\s+(?:o\s+)?curso/,
//     /conteÃºdo\s+do\s+curso\s+de/,
//     /o que\s+vou\s+aprender.*curso\s+de/,
//     /matÃ©rias\s+do\s+curso/,
//     /disciplinas.*curso\s+de/,
//     /grade\s+curricular.*curso/,
//     /objetivo.*curso\s+de/,
//     /onde\s+posso\s+trabalhar.*curso\s+de/,
//     /Ã¡rea\s+de\s+atuaÃ§Ã£o.*curso/,
//     /mercado\s+de\s+trabalho.*curso/,
//     /pÃºblico\s+alvo.*curso/,
//     /para\s+quem\s+Ã©.*curso\s+de/,
//     /quem\s+pode\s+fazer.*curso\s+de/,
//     /me fale sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /fale\s+sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /me conte sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /conte\s+sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quais\s+as\s+matÃ©rias\s+do\s+curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quais\s+matÃ©rias.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /que\s+matÃ©rias.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quais\s+as\s+disciplinas.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quais\s+disciplinas.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /qual\s+a\s+carga\s+horÃ¡ria\s+do\s+curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /qual\s+a\s+carga\s+horaria\s+do\s+curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /carga\s+horÃ¡ria.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /carga\s+horaria.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quantas\s+horas.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /explique\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /me explique\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /descreva\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /me descreva\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /duraÃ§Ã£o.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /duracao.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quanto\s+tempo\s+dura.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /tempo\s+de\s+duraÃ§Ã£o.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quantos\s+semestres.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quantos\s+anos.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /informaÃ§Ãµes\s+sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /informacoes\s+sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /detalhes\s+sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /gostaria\s+de\s+saber\s+sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quero\s+saber\s+sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /estrutura.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /mÃ³dulos.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /modulos.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quais\s+os\s+mÃ³dulos.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /matriz\s+curricular.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /ementa.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /objetivos.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /qual\s+o\s+objetivo.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quais\s+os\s+objetivos.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /finalidade.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /para\s+que\s+serve.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /competÃªncias.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /competencias.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /habilidades.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /skills.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /o\s+que\s+desenvolve.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /prÃ©-requisitos.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /pre\s+requisitos.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /requisitos.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /pÃºblico-alvo.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /publico\s+alvo.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quem\s+pode\s+fazer.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /onde\s+trabalhar.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /campo\s+de\s+trabalho.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /oportunidades.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /carreira.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /profissÃ£o.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /emprego.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /como\s+Ã©\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /vale\s+a\s+pena.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /Ã©\s+bom.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//   ];

//   return palavrasChaveDescricao.some((regex) => regex.test(msgLower));
// }

// /**
//  * Extrai o nome do curso de uma pergunta sobre descriÃ§Ã£o
//  */
// function extrairNomeCursoDaPergunta(userMessage) {
//   const padroes = [
//     /o que Ã©\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)?(.+?)(?:\?|$)/i,
//     /sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)?(.+?)(?:\?|$)/i,
//     /conteÃºdo\s+do\s+curso\s+(?:de\s+)?(.+?)(?:\?|$)/i,
//     /o que\s+vou\s+aprender.*curso\s+(?:de\s+)?(.+?)(?:\?|$)/i,
//     /matÃ©rias\s+do\s+curso\s+(?:de\s+)?(.+?)(?:\?|$)/i,
//     /^(.+?)\s+[-â€“]\s*(?:o que Ã©|sobre|conteÃºdo)/i,
//     /curso\s+(?:de\s+)?(.+?)\s+[-â€“]\s*(?:conteÃºdo|o que Ã©|sobre)/i,
//   ];

//   for (const padrao of padroes) {
//     const match = userMessage.match(padrao);
//     if (match && match[1]) {
//       let nomeCurso = match[1].trim();

//       // Limpar o nome extraÃ­do
//       nomeCurso = nomeCurso
//         .replace(/^(do|da|de|curso|tÃ©cnico|em|na|no)\s+/i, "")
//         .replace(/\s+(do|da|de|curso|tÃ©cnico|tem|existe)$/i, "")
//         .replace(/\s+e\s+.*/i, "")
//         .replace(/\s*[,;].*/i, "")
//         .trim();

//       // Verificar se o nome Ã© vÃ¡lido
//       const palavrasGenericas = [
//         "curso",
//         "cursos",
//         "tÃ©cnico",
//         "modalidade",
//         "ead",
//         "presencial",
//       ];
//       if (
//         nomeCurso.length > 2 &&
//         !palavrasGenericas.includes(nomeCurso.toLowerCase())
//       ) {
//         return nomeCurso;
//       }
//     }
//   }

//   // Fallback: procurar diretamente pelos nomes dos cursos disponÃ­veis
//   for (const curso of cursosDisponiveis) {
//     if (userMessage.toLowerCase().includes(curso.toLowerCase())) {
//       return curso;
//     }
//   }

//   return null;
// }

// /**
//  * Busca descriÃ§Ã£o de um curso no dicionÃ¡rio carregado
//  */
// function buscarDescricaoCurso(nomeCurso) {
//   if (!nomeCurso) return null;

//   // Garantir que as descriÃ§Ãµes estÃ£o carregadas
//   carregarDescricoesDoCSV();

//   // Normalizar o nome para busca
//   const nomeNormalizado = nomeCurso
//     .toLowerCase()
//     .normalize("NFD")
//     .replace(/[\u0300-\u036f]/g, "");

//   const curso = dicionarioDescricoes[nomeNormalizado];

//   if (curso) {
//     return `ğŸ“š **${curso.nome}**

// ğŸ¯ **Objetivo do Curso:**
// ${curso.objetivo}

// ğŸ‘¥ **PÃºblico-Alvo:**
// ${curso.publicoAlvo}

// ğŸ’¼ **Onde Pode Trabalhar:**
// ${curso.ondeTrabalhar}`;
//   }

//   return null;
// }

// // ============================================
// // ğŸ¤– FUNÃ‡ÃƒO PRINCIPAL DO CHAT
// // ============================================

// /**
//  * Envia a mensagem do usuÃ¡rio para o modelo GPT com histÃ³rico
//  */
// async function getChatResponse(userMessage, email) {
//   try {
//     const mensagens = [
//       {
//         role: "system",
//         content: `
// VocÃª Ã© o assistente virtual especializado em Cursos TÃ©cnicos do Senai ParanÃ¡.

// Sua missÃ£o Ã© acolher, informar e converter leads interessados em matrÃ­culas nos cursos tÃ©cnicos oferecidos pelo Senai ParanÃ¡.

// Adote um tom simpÃ¡tico, acolhedor, direto e Ãºtil. Sempre utilize gatilhos mentais para incentivar a realizaÃ§Ã£o da prÃ©-matrÃ­cula.

// ---

// ğŸ“š **CURSOS DISPONÃVEIS (APENAS ESTES EXISTEM):**
// ${cursosDisponiveis.map((curso) => `â€¢ ${curso}`).join("\n")}

// ğŸ™ï¸ **CIDADES DISPONÃVEIS (APENAS ESTAS EXISTEM):**
// ${cidadesDisponiveis.map((cidade) => `â€¢ ${cidade}`).join("\n")}

// âš ï¸ **IMPORTANTE:** VocÃª sÃ³ pode mencionar cursos e cidades que estÃ£o nas listas acima. Se o usuÃ¡rio perguntar sobre um curso ou cidade que nÃ£o existe na lista, informe educadamente que nÃ£o temos essa opÃ§Ã£o disponÃ­vel e sugira alternativas similares da lista ou peÃ§a para falar com um atendente.

// ---

// ğŸ¢ **TRATAMENTO ESPECIAL PARA CURITIBA:**

// Quando o usuÃ¡rio mencionar **"Curitiba"** como cidade desejada, vocÃª deve responder:

// "Ã“timo! Em Curitiba temos 4 unidades do SENAI para vocÃª escolher:

// ğŸ“ **BoqueirÃ£o** - RegiÃ£o sul de Curitiba
// ğŸ“ **Campus da IndÃºstria** - RegiÃ£o central
// ğŸ“ **CIC** - Cidade Industrial de Curitiba
// ğŸ“ **Dr. Celso Charuri** - RegiÃ£o especÃ­fica

// Qual dessas unidades fica mais prÃ³xima de vocÃª ou seria mais conveniente para estudar?

// Cada unidade pode ter cursos e horÃ¡rios diferentes, entÃ£o me diga qual vocÃª prefere para eu te dar informaÃ§Ãµes mais especÃ­ficas! ğŸ˜Š"

// **NUNCA** trate "Curitiba" como uma cidade especÃ­fica para busca de cursos. **SEMPRE** ofereÃ§a as 4 opÃ§Ãµes de unidades quando o usuÃ¡rio mencionar Curitiba.

// ---

// ğŸ¯ **IntenÃ§Ã£o: Fazer uma PrÃ©-MatrÃ­cula**

// Ao identificar alta intenÃ§Ã£o atravÃ©s das palavras-chave como:
// * "quero me inscrever"
// * "como faÃ§o a matrÃ­cula"
// * "tenho interesse no curso"
// * "quero garantir minha vaga"
// * "como funciona a prÃ©-matrÃ­cula"
// * "pode me cadastrar?"
// * "tem como reservar?"
// * "quero comeÃ§ar logo"

// Responda com:
// * Entusiasmo e acolhimento;
// * Convite claro e direto para prÃ©-matrÃ­cula;
// * Uso de gatilhos mentais (urgÃªncia, prova social, facilidade, autoridade);

// **Resposta modelo:**
// "Ã“timo saber do seu interesse! ğŸ˜Š Vamos garantir sua vaga com a prÃ©-matrÃ­cula. Ã‰ rÃ¡pido, fÃ¡cil e seguro. ğŸ‘‰ (https://www.senaipr.org.br/cursos-tecnicos/pre-matricula/)"

// ---

// ğŸ’¬ **IntenÃ§Ã£o: Falar com Atendente Humano**

// Se o usuÃ¡rio expressar frases como:
// * "quero falar com alguÃ©m"
// * "tem WhatsApp?"
// * "posso falar com um atendente?"
// * "prefiro conversar com uma pessoa"
// * "pode me chamar no WhatsApp?"

// Responda com:
// "Claro! Um dos nossos especialistas pode te atender pelo WhatsApp. Clique abaixo para conversar com a gente direto e tirar todas as suas dÃºvidas. ğŸ‘‰ (https://wa.me/5541987249685?text=)"

// ---

// ğŸ“Œ **Quando nÃ£o identificar claramente a intenÃ§Ã£o**, responda com foco em:
// * Informar sobre cursos disponÃ­veis, unidades, modalidades e valores;
// * Esclarecer dÃºvidas gerais;
// * Prioritariamente, convide o usuÃ¡rio a saber mais via WhatsApp ou formulÃ¡rio.

// Caso nÃ£o tenha a informaÃ§Ã£o especÃ­fica, indique que encaminharÃ¡ a dÃºvida para um atendente humano. NUNCA invente dados ou cursos que nÃ£o existem na lista.
//         `.trim(),
//       },
//     ];

//     // Carregar histÃ³rico de mensagens do usuÃ¡rio
//     if (email) {
//       try {
//         const [historico] = await pool.query(
//           "SELECT user_message, bot_response FROM messages WHERE email = ? ORDER BY id DESC LIMIT 10",
//           [email]
//         );

//         historico.reverse().forEach((m) => {
//           if (m.user_message && m.bot_response) {
//             mensagens.push({ role: "user", content: m.user_message });
//             mensagens.push({ role: "assistant", content: m.bot_response });
//           }
//         });
//       } catch (dbError) {
//         console.warn("âš ï¸ Erro ao carregar histÃ³rico do banco:", dbError);
//       }
//     }

//     mensagens.push({ role: "user", content: userMessage });

//     const completion = await openai.chat.completions.create({
//       model: "gpt-4o-mini",
//       messages: mensagens,
//       temperature: 0.7,
//       max_tokens: 600,
//     });

//     return completion.choices[0].message.content;
//   } catch (err) {
//     console.error("Erro ao chamar a OpenAI:", err);
//     throw new Error("Erro ao chamar a OpenAI");
//   }
// }

// // ============================================
// // ğŸ¯ FUNÃ‡ÃƒO DE EXTRAÃ‡ÃƒO DE FILTROS
// // ============================================

// /**
//  * Extrai filtros de texto para busca de cursos
//  */
// async function extrairFiltrosDeTexto(userMessage) {
//   // Se for pergunta sobre descriÃ§Ã£o, nÃ£o extrair filtros para busca
//   if (detectarPerguntaDescricao(userMessage)) {
//     console.log(
//       "ğŸ” Pergunta sobre descriÃ§Ã£o detectada - nÃ£o extraindo filtros de busca"
//     );
//     return { curso: "", cidade: "", modalidade: "" };
//   }

//   const prompt = `
// VocÃª Ã© um analisador especializado em extrair informaÃ§Ãµes sobre cursos tÃ©cnicos.

// CURSOS VÃLIDOS DISPONÃVEIS:
// ${cursosDisponiveis.map((curso) => `â€¢ ${curso}`).join("\n")}

// CIDADES VÃLIDAS DISPONÃVEIS:
// ${cidadesDisponiveis.map((cidade) => `â€¢ ${cidade}`).join("\n")}

// **REGRAS ESPECIAIS DE MAPEAMENTO:**

// ğŸ¢ **CURITIBA:**
// - Se o usuÃ¡rio mencionar "Curitiba" (e nÃ£o uma unidade especÃ­fica), deixe o campo cidade VAZIO ("")
// - Se o usuÃ¡rio mencionar especificamente: "BoqueirÃ£o", "Campus da IndÃºstria", "CIC", use exatamente esses nomes

// ğŸ™ï¸ **SÃƒO JOSÃ‰ DOS PINHAIS:**
// - Se o usuÃ¡rio mencionar: "SÃ£o JosÃ© dos Pinhais", "SÃ£o JosÃ©", "SJP", "Afonso Pena" â†’ use "Afonso Pena"
// - IMPORTANTE: "SÃ£o JosÃ© dos Pinhais" no CSV Ã© representado pela cidade "Afonso Pena"

// ğŸ­ **LONDRINA:**
// - Se o usuÃ¡rio mencionar "Londrina" (e nÃ£o uma unidade especÃ­fica), deixe o campo cidade VAZIO ("")
// - Se o usuÃ¡rio mencionar especificamente: "Dr. Celso Charuri", use exatamente esse nome

// Analise a mensagem e extraia APENAS se mencionado explicitamente:
// - "curso": nome do curso tÃ©cnico mencionado (DEVE estar na lista acima)
// - "cidade": cidade mencionada aplicando as regras de mapeamento acima
// - "modalidade": EAD, Presencial

// EXEMPLOS DE MAPEAMENTO:
// - "tem curso em SÃ£o JosÃ© dos Pinhais?" â†’ cidade: "Afonso Pena"
// - "curso em SJP" â†’ cidade: "Afonso Pena"
// - "curso em Afonso Pena" â†’ cidade: "Afonso Pena"
// - "curso em Curitiba" â†’ cidade: "" (vazio para oferecer opÃ§Ãµes)
// - "curso em BoqueirÃ£o" â†’ cidade: "BoqueirÃ£o"
// - "curso em Londrina" â†’ cidade: "" (vazio para oferecer opÃ§Ãµes)
// - "curso em Dr. Celso Charuri" â†’ cidade: "Dr. Celso Charuri"

// IMPORTANTE:
// - Se o curso mencionado nÃ£o estiver na lista vÃ¡lida, deixe campo vazio ("")
// - Para modalidade, normalize (ex: "online" = "EAD", "presencial" = "Presencial")

// Responda APENAS com JSON vÃ¡lido:

// {
//   "curso": "",
//   "cidade": "",
//   "modalidade": ""
// }

// Mensagem para analisar:
// "${userMessage}"
// `.trim();

//   try {
//     const completion = await openai.chat.completions.create({
//       model: "gpt-4o-mini",
//       messages: [{ role: "user", content: prompt }],
//       max_tokens: 200,
//       temperature: 0.1,
//     });

//     const texto = completion.choices[0].message.content.trim();
//     const match = texto.match(/\{[\s\S]*\}/);

//     if (match) {
//       const filtros = JSON.parse(match[0]);
//       console.log(`ğŸ” Filtros extraÃ­dos para "${userMessage}":`, filtros);
//       return filtros;
//     }

//     return { curso: "", cidade: "", modalidade: "" };
//   } catch (err) {
//     console.error("Erro ao interpretar filtros da IA:", err);
//     return { curso: "", cidade: "", modalidade: "" };
//   }
// }

// // ============================================
// // ğŸ™ï¸ FUNÃ‡ÃƒO AUXILIAR CURITIBA
// // ============================================

// /**
//  * Verifica se a mensagem menciona Curitiba de forma genÃ©rica
//  */
// function mencionaCuritibaGenerica(userMessage) {
//   const msgLower = userMessage.toLowerCase();
//   const variacesCuritiba = ["curitiba", "cwb", "ctba"];
//   const unidadesCuritiba = [
//     "boqueirÃ£o",
//     "boqueirao",
//     "campus da industria",
//     "campus da indÃºstria",
//     "cic",
//   ];

//   const mencionaCuritiba = variacesCuritiba.some((variacao) =>
//     msgLower.includes(variacao)
//   );
//   const mencionaUnidadeEspecifica = unidadesCuritiba.some((unidade) =>
//     msgLower.includes(unidade)
//   );

//   return mencionaCuritiba && !mencionaUnidadeEspecifica;
// }

// /**
//  * Verifica se a mensagem menciona Lodrina de forma generica
//  */

// function mencionaLondrinaGenerica(userMessage) {
//   const msgLower = userMessage.toLowerCase();
//   const variacoesLondrina = ["londrina", "londrina pr"];
//   const unidadeLondrina = [
//     "Dr. Celso Charuri",
//     "dr celso charuri",
//     "celso charuri",
//   ];

//   const mencionaLondrina = variacoesLondrina.some((variacao) =>
//     msgLower.includes(variacao)
//   );

//   const mencionaUnidadeEspecifica = unidadeLondrina.some((unidade) =>
//     msgLower.includes(unidade)
//   );

//   return mencionaLondrina && !mencionaUnidadeEspecifica;
// }

// function formatarCidadeParaFormulario(cidadeOriginal) {
//   if (!cidadeOriginal) return "";

//   const cidadeLower = cidadeOriginal.toLowerCase();

//   // Caso Afonso Pena (sede em SÃ£o JosÃ© dos Pinhais)
//   if (
//     cidadeLower.includes("sÃ£o josÃ© dos pinhais") ||
//     cidadeLower.includes("sao jose dos pinhais")
//   ) {
//     return "SÃ£o JosÃ© dos Pinhais - Afonso Pena";
//   }

//   // Casos especiais de Curitiba - unidades que precisam do formato "Curitiba - Unidade"
//   const unidadesCuritiba = {
//     boqueirÃ£o: "Curitiba - BoqueirÃ£o",
//     boqueirao: "Curitiba - BoqueirÃ£o",
//     "campus da indÃºstria": "Curitiba - Campus da IndÃºstria",
//     "campus da industria": "Curitiba - Campus da IndÃºstria",
//     cic: "Curitiba - CIC",
//   };

//   for (const [unidade, formato] of Object.entries(unidadesCuritiba)) {
//     if (cidadeLower.includes(unidade)) {
//       return formato;
//     }
//   }

//   return cidadeOriginal;
// }

// /**
//  * Gerar mensagem WhatsApp contextualizada com cidades especiais
//  */
// function gerarMensagemWhatsAppContextualizada(nome, curso, cidade) {
//   const cursoTexto = curso || "informaÃ§Ãµes sobre cursos tÃ©cnicos";

//   // Caso especial: SÃ£o JosÃ© dos Pinhais
//   if (
//     cidade &&
//     (cidade.toLowerCase().includes("sÃ£o josÃ© dos pinhais") ||
//       cidade.toLowerCase().includes("sao jose dos pinhais"))
//   ) {
//     return `OlÃ¡! Meu nome Ã© ${nome}, tenho interesse no curso de ${cursoTexto} na unidade Afonso Pena em SÃ£o JosÃ© dos Pinhais. Poderia me ajudar?`;
//   }

//   // Caso especial: Dr. Celso Charuri (unidade especÃ­fica de Londrina)
//   if (
//     cidade &&
//     (cidade.toLowerCase().includes("dr. celso charuri") ||
//       cidade.toLowerCase().includes("dr celso charuri") ||
//       cidade.toLowerCase().includes("celso charuri"))
//   ) {
//     return `OlÃ¡! Meu nome Ã© ${nome}, tenho interesse no curso de ${cursoTexto} na unidade Dr. Celso Charuri em Londrina. Poderia me ajudar?`;
//   }

//   // Casos de Curitiba (unidades especÃ­ficas)
//   const unidadesCuritiba = ["boqueirÃ£o", "campus da indÃºstria", "cic"];
//   const ehUnidadeCuritiba = unidadesCuritiba.some(
//     (unidade) => cidade && cidade.toLowerCase().includes(unidade.toLowerCase())
//   );

//   if (ehUnidadeCuritiba) {
//     return `OlÃ¡! Meu nome Ã© ${nome}, tenho interesse no curso de ${cursoTexto} na unidade ${cidade} em Curitiba. Poderia me ajudar?`;
//   }

//   // Caso padrÃ£o para cidades normais (incluindo "Londrina" como cidade principal)
//   if (cidade) {
//     return `OlÃ¡! Meu nome Ã© ${nome}, tenho interesse no curso de ${cursoTexto} em ${cidade}. Poderia me ajudar?`;
//   } else {
//     return `OlÃ¡! Meu nome Ã© ${nome}, tenho interesse em ${cursoTexto} do SENAI ParanÃ¡. Poderia me ajudar?`;
//   }
// }

// // ============================================
// // ğŸš€ INICIALIZAÃ‡ÃƒO
// // ============================================

// // Carregar dados na inicializaÃ§Ã£o
// // function inicializarServico() {
// //   try {
// //     const resultadoCursos = carregarCursosDoCSV();
// //     carregarDescricoesDoCSV();

// //     console.log("âœ… ServiÃ§o OpenAI inicializado com sucesso!");
// //     console.log(`ğŸ“š ${cursosDisponiveis.length} cursos carregados`);
// //     console.log(`ğŸ™ï¸ ${cidadesDisponiveis.length} cidades carregadas`);
// //   } catch (error) {
// //     console.error("âŒ Erro na inicializaÃ§Ã£o do serviÃ§o OpenAI:", error);
// //   }
// // }

// // ============================================
// // ğŸ“¤ EXPORTS
// // ============================================

// export {
//   getChatResponse,
//   extrairFiltrosDeTexto,
//   mencionaCuritibaGenerica,
//   mencionaLondrinaGenerica,
//   formatarCidadeParaFormulario,
//   gerarMensagemWhatsAppContextualizada,
//   detectarPerguntaDescricao,
//   extrairNomeCursoDaPergunta,
//   buscarDescricaoCurso,
//   carregarCursosDoCSV,
//   carregarDescricoesDoCSV,
// };

// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>><<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> NOVA VERSÃƒO TESTE 04/06/2025 <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>><<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

// process.env.NODE_TLS_REJECT_UNAUTHORIZED = "0";

// import dotenv from "dotenv";
// dotenv.config();

// import pkg from "openai";
// const { OpenAI } = pkg;
// import pool from "../config/db.js";
// import Papa from "papaparse";
// import fs from "fs";
// import path from "path";

// if (!process.env.OPENAI_API_KEY) {
//   throw new Error("âŒ OPENAI_API_KEY nÃ£o definida no .env");
// }

// const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

// // ============================================
// // ğŸ“š VARIÃVEIS GLOBAIS
// // ============================================
// let cursosDisponiveis = [];
// let cidadesDisponiveis = [];
// let dicionarioDescricoes = {};
// let descricaoCarregada = false;

// // ============================================
// // ğŸ—‚ï¸ FUNÃ‡ÃƒO PARA CARREGAR CURSOS
// // ============================================
// function carregarCursosDoCSV() {
//   try {
//     const csvPath = path.join(process.cwd(), "src", "data", "novos_cursos.csv");
//     console.log(`ğŸ“ Tentando carregar: ${csvPath}`);

//     if (!fs.existsSync(csvPath)) {
//       console.error(`âŒ Arquivo nÃ£o encontrado: ${csvPath}`);
//       return { cursosDisponiveis: [], cidadesDisponiveis: [] };
//     }

//     const csvData = fs.readFileSync(csvPath, "utf8");
//     console.log(`ğŸ“Š Tamanho do arquivo: ${csvData.length} caracteres`);

//     const result = Papa.parse(csvData, {
//       header: true,
//       skipEmptyLines: true,
//       dynamicTyping: false,
//       delimiter: ",", // ForÃ§a vÃ­rgula como separador
//       quoteChar: '"',
//     });

//     console.log(`ğŸ“Š Linhas processadas: ${result.data.length}`);
//     console.log(`ğŸ“‹ Colunas detectadas:`, result.meta.fields);

//     if (result.errors && result.errors.length > 0) {
//       console.warn("âš ï¸ Erros na parseaÃ§Ã£o:", result.errors);
//     }

//     const cursos = result.data;

//     // Debug do primeiro item
//     if (cursos.length > 0) {
//       console.log("\nğŸ” PRIMEIRO ITEM COMPLETO:");
//       Object.entries(cursos[0]).forEach(([key, value]) => {
//         console.log(`   "${key}": "${value}"`);
//       });
//     }

//     // EstratÃ©gias mÃºltiplas para extrair cursos
//     let cursosExtraidos = [];

//     // EstratÃ©gia 1: nome_curso
//     const estrategia1 = [
//       ...new Set(cursos.map((c) => c.nome_curso).filter(Boolean)),
//     ];
//     if (estrategia1.length > 0) {
//       cursosExtraidos = estrategia1;
//       console.log(
//         `âœ… Usando estratÃ©gia 1 (nome_curso): ${estrategia1.length} cursos`
//       );
//     }

//     // EstratÃ©gia 2: curso
//     if (cursosExtraidos.length === 0) {
//       const estrategia2 = [
//         ...new Set(cursos.map((c) => c.curso).filter(Boolean)),
//       ];
//       if (estrategia2.length > 0) {
//         cursosExtraidos = estrategia2;
//         console.log(
//           `âœ… Usando estratÃ©gia 2 (curso): ${estrategia2.length} cursos`
//         );
//       }
//     }

//     // EstratÃ©gia 3: Curso (maiÃºscula)
//     if (cursosExtraidos.length === 0) {
//       const estrategia3 = [
//         ...new Set(cursos.map((c) => c.Curso).filter(Boolean)),
//       ];
//       if (estrategia3.length > 0) {
//         cursosExtraidos = estrategia3;
//         console.log(
//           `âœ… Usando estratÃ©gia 3 (Curso): ${estrategia3.length} cursos`
//         );
//       }
//     }

//     // Extrair cidades
//     const cidadesExtraidas = [
//       ...new Set(cursos.map((c) => c.cidade).filter(Boolean)),
//     ];

//     console.log(`\nâœ… RESULTADO FINAL:`);
//     console.log(`   Cursos Ãºnicos: ${cursosExtraidos.length}`);
//     console.log(`   Cidades Ãºnicas: ${cidadesExtraidas.length}`);

//     if (cursosExtraidos.length > 0) {
//       console.log(
//         `   Exemplos de cursos: ${cursosExtraidos.slice(0, 3).join(", ")}`
//       );
//     }

//     if (cidadesExtraidas.length > 0) {
//       console.log(
//         `   Exemplos de cidades: ${cidadesExtraidas.slice(0, 3).join(", ")}`
//       );
//     }

//     // Atualizar variÃ¡veis globais
//     cursosDisponiveis = cursosExtraidos;
//     cidadesDisponiveis = cidadesExtraidas;

//     return {
//       cursosDisponiveis: cursosExtraidos,
//       cidadesDisponiveis: cidadesExtraidas,
//     };
//   } catch (error) {
//     console.error("âŒ Erro ao carregar cursos do CSV:", error);
//     return { cursosDisponiveis: [], cidadesDisponiveis: [] };
//   }
// }

// // ============================================
// // ğŸ“– FUNÃ‡ÃƒO PARA CARREGAR DESCRIÃ‡Ã•ES
// // ============================================
// function carregarDescricoesDoCSV() {
//   if (descricaoCarregada) {
//     return dicionarioDescricoes;
//   }

//   try {
//     const csvPath = path.join(
//       process.cwd(),
//       "src",
//       "data",
//       "curso_tecnicos.csv"
//     );

//     if (!fs.existsSync(csvPath)) {
//       console.warn("âš ï¸ Arquivo de descriÃ§Ãµes nÃ£o encontrado:", csvPath);
//       return {};
//     }

//     const csvData = fs.readFileSync(csvPath, "utf8");

//     const result = Papa.parse(csvData, {
//       header: true,
//       skipEmptyLines: true,
//       dynamicTyping: false,
//       delimiter: ",",
//       quoteChar: '"',
//     });

//     const descricoes = result.data;
//     dicionarioDescricoes = {};

//     // Processar cada linha do CSV
//     descricoes.forEach((row) => {
//       const nomeBruto = row["Nome do Curso"];
//       if (!nomeBruto) return;

//       // Normalizar o nome para busca
//       const nomeNormalizado = nomeBruto
//         .toLowerCase()
//         .normalize("NFD")
//         .replace(/[\u0300-\u036f]/g, "");

//       // Armazenar no dicionÃ¡rio
//       dicionarioDescricoes[nomeNormalizado] = {
//         nome: nomeBruto,
//         objetivo: row["Objetivos do Curso"] || "InformaÃ§Ã£o nÃ£o disponÃ­vel",
//         publicoAlvo: row["PÃºblico-Alvo"] || "InformaÃ§Ã£o nÃ£o disponÃ­vel",
//         ondeTrabalhar:
//           row["Onde Pode Trabalhar"] || "InformaÃ§Ã£o nÃ£o disponÃ­vel",
//       };
//     });

//     descricaoCarregada = true;
//     console.log(
//       `âœ… Carregadas descriÃ§Ãµes de ${
//         Object.keys(dicionarioDescricoes).length
//       } cursos`
//     );

//     return dicionarioDescricoes;
//   } catch (error) {
//     console.error("âŒ Erro ao carregar descriÃ§Ãµes do CSV:", error);
//     return {};
//   }
// }

// // ============================================
// // ğŸ” FUNÃ‡Ã•ES DE DETECÃ‡ÃƒO DE PERGUNTAS SOBRE DESCRIÃ‡ÃƒO
// // ============================================

// /**
//  * Detecta se o usuÃ¡rio estÃ¡ perguntando sobre descriÃ§Ã£o/conteÃºdo de um curso especÃ­fico
//  */
// function detectarPerguntaDescricao(userMessage) {
//   const msgLower = userMessage.toLowerCase();

//   // ExclusÃµes - NÃƒO sÃ£o perguntas sobre descriÃ§Ã£o
//   const exclusoes = [
//     /tem\?$/,
//     /vocÃªs tÃªm/,
//     /existe/,
//     /disponÃ­vel/,
//     /oferece/,
//     /em\s+\w+.*modalidade/,
//     /modalidade.*em\s+\w+/,
//     /na\s+modalidade.*em/,
//     /em\s+\w+.*ead|presencial/,
//     /quais\s+cursos/,
//     /que\s+cursos/,
//     /lista.*cursos/,
//   ];

//   if (exclusoes.some((regex) => regex.test(msgLower))) {
//     return false;
//   }

//   // InclusÃµes - SÃƒO perguntas sobre descriÃ§Ã£o
//   const palavrasChaveDescricao = [
//     /o que Ã©\s+(?:o\s+)?curso\s+de\s+\w+/,
//     /sobre\s+o\s+curso\s+de\s+\w+/,
//     /do que se trata\s+(?:o\s+)?curso/,
//     /conteÃºdo\s+do\s+curso\s+de/,
//     /o que\s+vou\s+aprender.*curso\s+de/,
//     /matÃ©rias\s+do\s+curso/,
//     /disciplinas.*curso\s+de/,
//     /grade\s+curricular.*curso/,
//     /objetivo.*curso\s+de/,
//     /onde\s+posso\s+trabalhar.*curso\s+de/,
//     /Ã¡rea\s+de\s+atuaÃ§Ã£o.*curso/,
//     /mercado\s+de\s+trabalho.*curso/,
//     /pÃºblico\s+alvo.*curso/,
//     /para\s+quem\s+Ã©.*curso\s+de/,
//     /quem\s+pode\s+fazer.*curso\s+de/,
//     /me fale sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /fale\s+sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /me conte sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /conte\s+sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quais\s+as\s+matÃ©rias\s+do\s+curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quais\s+matÃ©rias.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /que\s+matÃ©rias.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quais\s+as\s+disciplinas.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quais\s+disciplinas.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /qual\s+a\s+carga\s+horÃ¡ria\s+do\s+curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /qual\s+a\s+carga\s+horaria\s+do\s+curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /carga\s+horÃ¡ria.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /carga\s+horaria.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quantas\s+horas.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /explique\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /me explique\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /descreva\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /me descreva\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /duraÃ§Ã£o.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /duracao.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quanto\s+tempo\s+dura.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /tempo\s+de\s+duraÃ§Ã£o.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quantos\s+semestres.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quantos\s+anos.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /informaÃ§Ãµes\s+sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /informacoes\s+sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /detalhes\s+sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /gostaria\s+de\s+saber\s+sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quero\s+saber\s+sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /estrutura.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /mÃ³dulos.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /modulos.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quais\s+os\s+mÃ³dulos.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /matriz\s+curricular.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /ementa.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /objetivos.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /qual\s+o\s+objetivo.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quais\s+os\s+objetivos.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /finalidade.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /para\s+que\s+serve.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /competÃªncias.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /competencias.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /habilidades.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /skills.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /o\s+que\s+desenvolve.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /prÃ©-requisitos.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /pre\s+requisitos.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /requisitos.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /pÃºblico-alvo.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /publico\s+alvo.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /quem\s+pode\s+fazer.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /onde\s+trabalhar.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /campo\s+de\s+trabalho.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /oportunidades.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /carreira.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /profissÃ£o.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /emprego.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /como\s+Ã©\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /vale\s+a\s+pena.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//     /Ã©\s+bom.*curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)\w+/,
//   ];

//   return palavrasChaveDescricao.some((regex) => regex.test(msgLower));
// }

// /**
//  * Extrai o nome do curso de uma pergunta sobre descriÃ§Ã£o
//  */
// function extrairNomeCursoDaPergunta(userMessage) {
//   const padroes = [
//     /o que Ã©\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)?(.+?)(?:\?|$)/i,
//     /sobre\s+(?:o\s+)?curso\s+(?:de\s+|tÃ©cnico\s+(?:de\s+)?)?(.+?)(?:\?|$)/i,
//     /conteÃºdo\s+do\s+curso\s+(?:de\s+)?(.+?)(?:\?|$)/i,
//     /o que\s+vou\s+aprender.*curso\s+(?:de\s+)?(.+?)(?:\?|$)/i,
//     /matÃ©rias\s+do\s+curso\s+(?:de\s+)?(.+?)(?:\?|$)/i,
//     /^(.+?)\s+[-â€“]\s*(?:o que Ã©|sobre|conteÃºdo)/i,
//     /curso\s+(?:de\s+)?(.+?)\s+[-â€“]\s*(?:conteÃºdo|o que Ã©|sobre)/i,
//   ];

//   for (const padrao of padroes) {
//     const match = userMessage.match(padrao);
//     if (match && match[1]) {
//       let nomeCurso = match[1].trim();

//       // Limpar o nome extraÃ­do
//       nomeCurso = nomeCurso
//         .replace(/^(do|da|de|curso|tÃ©cnico|em|na|no)\s+/i, "")
//         .replace(/\s+(do|da|de|curso|tÃ©cnico|tem|existe)$/i, "")
//         .replace(/\s+e\s+.*/i, "")
//         .replace(/\s*[,;].*/i, "")
//         .trim();

//       // Verificar se o nome Ã© vÃ¡lido
//       const palavrasGenericas = [
//         "curso",
//         "cursos",
//         "tÃ©cnico",
//         "modalidade",
//         "ead",
//         "presencial",
//       ];
//       if (
//         nomeCurso.length > 2 &&
//         !palavrasGenericas.includes(nomeCurso.toLowerCase())
//       ) {
//         return nomeCurso;
//       }
//     }
//   }

//   // Fallback: procurar diretamente pelos nomes dos cursos disponÃ­veis
//   for (const curso of cursosDisponiveis) {
//     if (userMessage.toLowerCase().includes(curso.toLowerCase())) {
//       return curso;
//     }
//   }

//   return null;
// }

// /**
//  * Busca descriÃ§Ã£o de um curso no dicionÃ¡rio carregado
//  */
// function buscarDescricaoCurso(nomeCurso) {
//   if (!nomeCurso) return null;

//   // Garantir que as descriÃ§Ãµes estÃ£o carregadas
//   carregarDescricoesDoCSV();

//   // Normalizar o nome para busca
//   const nomeNormalizado = nomeCurso
//     .toLowerCase()
//     .normalize("NFD")
//     .replace(/[\u0300-\u036f]/g, "");

//   const curso = dicionarioDescricoes[nomeNormalizado];

//   if (curso) {
//     return `ğŸ“š **${curso.nome}**

// ğŸ¯ **Objetivo do Curso:**
// ${curso.objetivo}

// ğŸ‘¥ **PÃºblico-Alvo:**
// ${curso.publicoAlvo}

// ğŸ’¼ **Onde Pode Trabalhar:**
// ${curso.ondeTrabalhar}`;
//   }

//   return null;
// }

// // ============================================
// // ğŸ¤– FUNÃ‡ÃƒO PRINCIPAL DO CHAT
// // ============================================

// /**
//  * Envia a mensagem do usuÃ¡rio para o modelo GPT com histÃ³rico
//  */
// async function getChatResponse(userMessage, email) {
//   try {
//     const mensagens = [
//       {
//         role: "system",
//         content: `
// VocÃª Ã© o assistente virtual especializado em Cursos TÃ©cnicos do Senai ParanÃ¡.

// Sua missÃ£o Ã© acolher, informar e converter leads interessados em matrÃ­culas nos cursos tÃ©cnicos oferecidos pelo Senai ParanÃ¡.

// Adote um tom simpÃ¡tico, acolhedor, direto e Ãºtil. Sempre utilize gatilhos mentais para incentivar a realizaÃ§Ã£o da prÃ©-matrÃ­cula.

// ---

// ğŸ“š **CURSOS DISPONÃVEIS (APENAS ESTES EXISTEM):**
// ${cursosDisponiveis.map((curso) => `â€¢ ${curso}`).join("\n")}

// ğŸ™ï¸ **CIDADES DISPONÃVEIS (APENAS ESTAS EXISTEM):**
// ${cidadesDisponiveis.map((cidade) => `â€¢ ${cidade}`).join("\n")}

// âš ï¸ **IMPORTANTE:** VocÃª sÃ³ pode mencionar cursos e cidades que estÃ£o nas listas acima. Se o usuÃ¡rio perguntar sobre um curso ou cidade que nÃ£o existe na lista, informe educadamente que nÃ£o temos essa opÃ§Ã£o disponÃ­vel e sugira alternativas similares da lista ou peÃ§a para falar com um atendente.

// ---

// ğŸ¢ **TRATAMENTO ESPECIAL PARA CURITIBA:**

// Quando o usuÃ¡rio mencionar **"Curitiba"** como cidade desejada, vocÃª deve responder:

// "Ã“timo! Em Curitiba temos 4 unidades do SENAI para vocÃª escolher:

// ğŸ“ **BoqueirÃ£o** - RegiÃ£o sul de Curitiba
// ğŸ“ **Campus da IndÃºstria** - RegiÃ£o central
// ğŸ“ **CIC** - Cidade Industrial de Curitiba
// ğŸ“ **Dr. Celso Charuri** - RegiÃ£o especÃ­fica

// Qual dessas unidades fica mais prÃ³xima de vocÃª ou seria mais conveniente para estudar?

// Cada unidade pode ter cursos e horÃ¡rios diferentes, entÃ£o me diga qual vocÃª prefere para eu te dar informaÃ§Ãµes mais especÃ­ficas! ğŸ˜Š"

// **NUNCA** trate "Curitiba" como uma cidade especÃ­fica para busca de cursos. **SEMPRE** ofereÃ§a as 4 opÃ§Ãµes de unidades quando o usuÃ¡rio mencionar Curitiba.

// ---

// ğŸ¯ **IntenÃ§Ã£o: Fazer uma PrÃ©-MatrÃ­cula**

// Ao identificar alta intenÃ§Ã£o atravÃ©s das palavras-chave como:
// * "quero me inscrever"
// * "como faÃ§o a matrÃ­cula"
// * "tenho interesse no curso"
// * "quero garantir minha vaga"
// * "como funciona a prÃ©-matrÃ­cula"
// * "pode me cadastrar?"
// * "tem como reservar?"
// * "quero comeÃ§ar logo"

// Responda com:
// * Entusiasmo e acolhimento;
// * Convite claro e direto para prÃ©-matrÃ­cula;
// * Uso de gatilhos mentais (urgÃªncia, prova social, facilidade, autoridade);

// **Resposta modelo:**
// "Ã“timo saber do seu interesse! ğŸ˜Š Vamos garantir sua vaga com a prÃ©-matrÃ­cula. Ã‰ rÃ¡pido, fÃ¡cil e seguro. ğŸ‘‰ (https://www.senaipr.org.br/cursos-tecnicos/pre-matricula/)"

// ---

// ğŸ’¬ **IntenÃ§Ã£o: Falar com Atendente Humano**

// Se o usuÃ¡rio expressar frases como:
// * "quero falar com alguÃ©m"
// * "tem WhatsApp?"
// * "posso falar com um atendente?"
// * "prefiro conversar com uma pessoa"
// * "pode me chamar no WhatsApp?"

// Responda com:
// "Claro! Um dos nossos especialistas pode te atender pelo WhatsApp. Clique abaixo para conversar com a gente direto e tirar todas as suas dÃºvidas. ğŸ‘‰ (https://wa.me/5541987249685?text=)"

// ---

// ğŸ“Œ **Quando nÃ£o identificar claramente a intenÃ§Ã£o**, responda com foco em:
// * Informar sobre cursos disponÃ­veis, unidades, modalidades e valores;
// * Esclarecer dÃºvidas gerais;
// * Prioritariamente, convide o usuÃ¡rio a saber mais via WhatsApp ou formulÃ¡rio.

// Caso nÃ£o tenha a informaÃ§Ã£o especÃ­fica, indique que encaminharÃ¡ a dÃºvida para um atendente humano. NUNCA invente dados ou cursos que nÃ£o existem na lista.
//         `.trim(),
//       },
//     ];

//     // Carregar histÃ³rico de mensagens do usuÃ¡rio
//     if (email) {
//       try {
//         const [historico] = await pool.query(
//           "SELECT user_message, bot_response FROM messages WHERE email = ? ORDER BY id DESC LIMIT 10",
//           [email]
//         );

//         historico.reverse().forEach((m) => {
//           if (m.user_message && m.bot_response) {
//             mensagens.push({ role: "user", content: m.user_message });
//             mensagens.push({ role: "assistant", content: m.bot_response });
//           }
//         });
//       } catch (dbError) {
//         console.warn("âš ï¸ Erro ao carregar histÃ³rico do banco:", dbError);
//       }
//     }

//     mensagens.push({ role: "user", content: userMessage });

//     const completion = await openai.chat.completions.create({
//       model: "gpt-4o-mini",
//       messages: mensagens,
//       temperature: 0.7,
//       max_tokens: 600,
//     });

//     return completion.choices[0].message.content;
//   } catch (err) {
//     console.error("Erro ao chamar a OpenAI:", err);
//     throw new Error("Erro ao chamar a OpenAI");
//   }
// }

// // ============================================
// // ğŸ¯ FUNÃ‡ÃƒO DE EXTRAÃ‡ÃƒO DE FILTROS - SIMPLIFICADA
// // ============================================

// /**
//  * Extrai filtros de texto para busca de cursos - VERSÃƒO SIMPLIFICADA
//  */
// async function extrairFiltrosDeTexto(userMessage) {
//   // Se for pergunta sobre descriÃ§Ã£o, nÃ£o extrair filtros para busca
//   if (detectarPerguntaDescricao(userMessage)) {
//     console.log(
//       "ğŸ” Pergunta sobre descriÃ§Ã£o detectada - nÃ£o extraindo filtros de busca"
//     );
//     return { curso: "", cidade: "", modalidade: "" };
//   }

//   const prompt = `
// VocÃª Ã© um analisador especializado em extrair informaÃ§Ãµes sobre cursos tÃ©cnicos.

// CURSOS VÃLIDOS DISPONÃVEIS:
// ${cursosDisponiveis.map((curso) => `â€¢ ${curso}`).join("\n")}

// CIDADES VÃLIDAS DISPONÃVEIS:
// ${cidadesDisponiveis.map((cidade) => `â€¢ ${cidade}`).join("\n")}

// **REGRAS ESPECIAIS DE MAPEAMENTO:**

// ğŸ¢ **CURITIBA:**
// - Se o usuÃ¡rio mencionar "Curitiba" (e nÃ£o uma unidade especÃ­fica), deixe o campo cidade VAZIO ("")
// - Se o usuÃ¡rio mencionar especificamente: "BoqueirÃ£o", "Campus da IndÃºstria", "CIC", use exatamente esses nomes

// ğŸ™ï¸ **SÃƒO JOSÃ‰ DOS PINHAIS:**
// - Se o usuÃ¡rio mencionar: "SÃ£o JosÃ© dos Pinhais", "SÃ£o JosÃ©", "SJP" â†’ use "SÃ£o JosÃ© dos Pinhais"
// - Agora estÃ¡ correto no CSV como "SÃ£o JosÃ© dos Pinhais"

// ğŸ­ **LONDRINA:**
// - Se o usuÃ¡rio mencionar "Londrina" (e nÃ£o uma unidade especÃ­fica), deixe o campo cidade VAZIO ("")
// - Se o usuÃ¡rio mencionar especificamente: "Dr. Celso Charuri", use exatamente esse nome

// Analise a mensagem e extraia APENAS se mencionado explicitamente:
// - "curso": nome do curso tÃ©cnico mencionado (DEVE estar na lista acima)
// - "cidade": cidade mencionada aplicando as regras de mapeamento acima
// - "modalidade": EAD, Presencial

// EXEMPLOS DE MAPEAMENTO SIMPLIFICADOS:
// - "tem curso em SÃ£o JosÃ© dos Pinhais?" â†’ cidade: "SÃ£o JosÃ© dos Pinhais"
// - "curso em SJP" â†’ cidade: "SÃ£o JosÃ© dos Pinhais"
// - "curso em Curitiba" â†’ cidade: "" (vazio para oferecer opÃ§Ãµes)
// - "curso em BoqueirÃ£o" â†’ cidade: "BoqueirÃ£o"
// - "curso em Londrina" â†’ cidade: "" (vazio para oferecer opÃ§Ãµes)
// - "curso em Dr. Celso Charuri" â†’ cidade: "Dr. Celso Charuri"

// IMPORTANTE:
// - Se o curso mencionado nÃ£o estiver na lista vÃ¡lida, deixe campo vazio ("")
// - Para modalidade, normalize (ex: "online" = "EAD", "presencial" = "Presencial")

// Responda APENAS com JSON vÃ¡lido:

// {
//   "curso": "",
//   "cidade": "",
//   "modalidade": ""
// }

// Mensagem para analisar:
// "${userMessage}"
// `.trim();

//   try {
//     const completion = await openai.chat.completions.create({
//       model: "gpt-4o-mini",
//       messages: [{ role: "user", content: prompt }],
//       max_tokens: 200,
//       temperature: 0.1,
//     });

//     const texto = completion.choices[0].message.content.trim();
//     const match = texto.match(/\{[\s\S]*\}/);

//     if (match) {
//       const filtros = JSON.parse(match[0]);
//       console.log(`ğŸ” Filtros extraÃ­dos para "${userMessage}":`, filtros);
//       return filtros;
//     }

//     return { curso: "", cidade: "", modalidade: "" };
//   } catch (err) {
//     console.error("Erro ao interpretar filtros da IA:", err);
//     return { curso: "", cidade: "", modalidade: "" };
//   }
// }

// // ============================================
// // ğŸ™ï¸ FUNÃ‡Ã•ES AUXILIARES SIMPLIFICADAS
// // ============================================

// /**
//  * Verifica se a mensagem menciona Curitiba de forma genÃ©rica
//  */
// function mencionaCuritibaGenerica(userMessage) {
//   const msgLower = userMessage.toLowerCase();
//   const variacesCuritiba = ["curitiba", "cwb", "ctba"];
//   const unidadesCuritiba = [
//     "boqueirÃ£o",
//     "boqueirao",
//     "campus da industria",
//     "campus da indÃºstria",
//     "cic",
//   ];

//   const mencionaCuritiba = variacesCuritiba.some((variacao) =>
//     msgLower.includes(variacao)
//   );
//   const mencionaUnidadeEspecifica = unidadesCuritiba.some((unidade) =>
//     msgLower.includes(unidade)
//   );

//   return mencionaCuritiba && !mencionaUnidadeEspecifica;
// }

// /**
//  * Verifica se a mensagem menciona Londrina de forma genÃ©rica
//  */
// function mencionaLondrinaGenerica(userMessage) {
//   const msgLower = userMessage.toLowerCase();
//   const variacoesLondrina = ["londrina", "londrina pr"];
//   const unidadeLondrina = [
//     "Dr. Celso Charuri",
//     "dr celso charuri",
//     "celso charuri",
//   ];

//   const mencionaLondrina = variacoesLondrina.some((variacao) =>
//     msgLower.includes(variacao)
//   );

//   const mencionaUnidadeEspecifica = unidadeLondrina.some((unidade) =>
//     msgLower.includes(unidade)
//   );

//   return mencionaLondrina && !mencionaUnidadeEspecifica;
// }

// /**
//  * Formatar cidade para formulÃ¡rio - SIMPLIFICADO
//  */
// function formatarCidadeParaFormulario(cidadeOriginal) {
//   if (!cidadeOriginal) return "";

//   const cidadeLower = cidadeOriginal.toLowerCase();

//   // Casos especiais de Curitiba - unidades que precisam do formato "Curitiba - Unidade"
//   const unidadesCuritiba = {
//     boqueirÃ£o: "Curitiba - BoqueirÃ£o",
//     boqueirao: "Curitiba - BoqueirÃ£o",
//     "campus da indÃºstria": "Curitiba - Campus da IndÃºstria",
//     "campus da industria": "Curitiba - Campus da IndÃºstria",
//     cic: "Curitiba - CIC",
//   };

//   for (const [unidade, formato] of Object.entries(unidadesCuritiba)) {
//     if (cidadeLower.includes(unidade)) {
//       return formato;
//     }
//   }

//   // Para todas as outras cidades, usar como estÃ¡ (incluindo "SÃ£o JosÃ© dos Pinhais")
//   return cidadeOriginal;
// }

// /**
//  * Gerar mensagem WhatsApp contextualizada - SIMPLIFICADA
//  */
// function gerarMensagemWhatsAppContextualizada(nome, curso, cidade) {
//   const cursoTexto = curso || "informaÃ§Ãµes sobre cursos tÃ©cnicos";

//   // Caso especial: Dr. Celso Charuri (unidade especÃ­fica de Londrina)
//   if (
//     cidade &&
//     (cidade.toLowerCase().includes("dr. celso charuri") ||
//       cidade.toLowerCase().includes("dr celso charuri") ||
//       cidade.toLowerCase().includes("celso charuri"))
//   ) {
//     return `OlÃ¡! Meu nome Ã© ${nome}, tenho interesse no curso de ${cursoTexto} na unidade Dr. Celso Charuri em Londrina. Poderia me ajudar?`;
//   }

//   // Casos de Curitiba (unidades especÃ­ficas)
//   const unidadesCuritiba = ["boqueirÃ£o", "campus da indÃºstria", "cic"];
//   const ehUnidadeCuritiba = unidadesCuritiba.some(
//     (unidade) => cidade && cidade.toLowerCase().includes(unidade.toLowerCase())
//   );

//   if (ehUnidadeCuritiba) {
//     return `OlÃ¡! Meu nome Ã© ${nome}, tenho interesse no curso de ${cursoTexto} na unidade ${cidade} em Curitiba. Poderia me ajudar?`;
//   }

//   // Caso padrÃ£o para todas as outras cidades (incluindo SÃ£o JosÃ© dos Pinhais)
//   if (cidade) {
//     return `OlÃ¡! Meu nome Ã© ${nome}, tenho interesse no curso de ${cursoTexto} em ${cidade}. Poderia me ajudar?`;
//   } else {
//     return `OlÃ¡! Meu nome Ã© ${nome}, tenho interesse em ${cursoTexto} do SENAI ParanÃ¡. Poderia me ajudar?`;
//   }
// }

// // ============================================
// // ğŸ“¤ EXPORTS
// // ============================================

// export {
//   getChatResponse,
//   extrairFiltrosDeTexto,
//   mencionaCuritibaGenerica,
//   mencionaLondrinaGenerica,
//   formatarCidadeParaFormulario,
//   gerarMensagemWhatsAppContextualizada,
//   detectarPerguntaDescricao,
//   extrairNomeCursoDaPergunta,
//   buscarDescricaoCurso,
//   carregarCursosDoCSV,
//   carregarDescricoesDoCSV,
// };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   